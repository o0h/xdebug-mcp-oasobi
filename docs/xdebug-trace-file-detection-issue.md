# Xdebug Trace File Detection Issue

## Overview

The `xdebug-trace` tool fails to detect trace files generated by Xdebug, resulting in the error message "Trace file not created. Check Xdebug installation." even when trace files are successfully generated.

## Environment

- **xdebug-mcp version**: v0.3.0 (commit: 1b8af8ead3e094fff8c65fbe6784be120f1f6342)
- **PHP version**: 8.x
- **Xdebug version**: 3.x
- **Operating System**: macOS (likely affects other platforms)

## Issue Description

### What's Happening

1. The `xdebug-trace` tool executes PHP scripts with Xdebug tracing enabled
2. Xdebug successfully generates trace files in the output directory
3. The tool fails to find the generated files and throws an error
4. Manual inspection reveals trace files exist but with different naming patterns

### Root Cause Analysis

The issue stems from a hardcoded file pattern in `XdebugTracer.php`:

```php
// Current problematic code (line ~139)
$traceFiles = glob("{$xdebugOutputDir}/trace.*.xt");
```

However, the actual trace filename format is determined by the `xdebug.trace_output_name` configuration:

```bash
$ php -r "echo ini_get('xdebug.trace_output_name');"
stack_trace.%c.%s.%u
```

This results in files like:
```
stack_trace.3664195518._Users_o0h_src_github.com_o0h_xdebug-mcp-oasobi_vendor_koriym_xdebug-mcp_prepend_filter_php.1757729752.368805.xt
```

### Pattern Mismatch

| Expected Pattern | `trace.*.xt` |
|------------------|--------------|
| **Actual Pattern** | `stack_trace.*.*.*.xt` |
| **Result** | No files found |

## Proposed Solution

### Dynamic Pattern Detection

Instead of hardcoding the filename pattern, read the current `xdebug.trace_output_name` setting and construct the glob pattern dynamically:

```php
public function executeTrace(string $targetFile, array $phpArgs = []): string
{
    // ... existing code until PHP execution ...

    // Get current trace_output_name setting (same approach as xdebug.output_dir)
    $traceOutputName = ini_get('xdebug.trace_output_name') ?: 'trace.%c';
    
    // Convert Xdebug format specifiers to glob wildcards
    // %c=CRC32, %p=PID, %r=Random, %s=Script, %t=Timestamp, %u=Microseconds, etc.
    $filePattern = preg_replace('/%(c|p|r|s|t|u|H|R|U|S)/', '*', $traceOutputName);
    
    // Find trace files using dynamic pattern
    $traceFiles = glob("{$xdebugOutputDir}/{$filePattern}.xt");
    
    if (empty($traceFiles)) {
        throw new RuntimeException('Trace file not created. Check Xdebug installation.');
    }

    // Sort by modification time (newest first) - existing logic
    usort($traceFiles, static function ($a, $b) {
        return filemtime($b) - filemtime($a);
    });

    return $traceFiles[0];
}
```

### Benefits

1. **Configuration Agnostic**: Works with any `xdebug.trace_output_name` setting
2. **Future Proof**: Automatically handles new format specifiers
3. **Consistent Approach**: Uses same pattern as `xdebug.output_dir` handling
4. **Backward Compatible**: Still works with default `trace.%c` format

## Testing

### Proof of Concept

Created test script demonstrating the solution:

```bash
$ php improved_trace_finder.php
üéØ Testing improved trace file finder
üìÇ Output directory: /usr/local/var/log/php
üìã Current xdebug.trace_output_name: stack_trace.%c.%s.%u
üîç Generated glob pattern: /usr/local/var/log/php/stack_trace.*.*.*.xt
‚úÖ Found 388 trace file(s)
üìÅ Most recent: stack_trace.3664195518...
üéâ Success! Dynamic pattern matching works.
```

### Format Specifiers Mapping

| Xdebug Specifier | Description | Glob Replacement |
|------------------|-------------|------------------|
| `%c` | CRC32 of current working directory | `*` |
| `%p` | Process ID | `*` |
| `%r` | Random number | `*` |
| `%s` | Script name | `*` |
| `%t` | Timestamp (seconds) | `*` |
| `%u` | Timestamp (microseconds) | `*` |
| `%H` | HTTP Host | `*` |
| `%R` | Request URI | `*` |
| `%U` | Unique ID | `*` |
| `%S` | Session ID | `*` |

## Impact

### Current State
- ‚ùå Tool fails with default Xdebug configuration
- ‚ùå Users get confusing error messages
- ‚ùå Manual workarounds required

### After Fix
- ‚úÖ Works with any Xdebug trace filename configuration
- ‚úÖ Clear, accurate error messages when trace actually fails
- ‚úÖ Zero configuration required from users

## References

- [Xdebug Trace Documentation - Output Filename](https://xdebug.org/docs/trace#trace_output_name)
- [Xdebug Format Specifiers](https://xdebug.org/docs/trace#trace_output_name)

## Additional Notes

This issue may affect other tools in the xdebug-mcp suite that rely on finding generated files. A similar approach could be applied to profile and other output file detection mechanisms.

---

**Priority**: High - affects core functionality
**Complexity**: Low - straightforward configuration reading and string replacement
**Breaking Changes**: None - fully backward compatible